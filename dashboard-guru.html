<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Guru</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * {box-sizing: border-box; margin:0; padding:0; font-family: 'Roboto', sans-serif;}

    body {
      background: linear-gradient(to right, #e0eafc, #cfdef3);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #0077cc;
      color: #fff;
      padding: 15px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header span { flex:1; text-align:center; }
    header button {
      background: #ff4d4d;
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .container { flex: 1; padding: 20px; }

    .card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
      padding: 20px;
      margin-bottom: 20px;
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 15px;
      text-align: center;
      color: #333;
    }

    .input-group {
      margin-bottom: 15px;
      position: relative;
    }
    .input-group i {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
    }
    .input-group input {
      width: 100%;
      padding: 12px 12px 12px 35px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 15px;
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background-color: #0077cc;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover { background: #005fa3; }

    .qr-list { margin-top: 20px; }
    .qr-item {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      text-align: center;
    }
    .qr-item h4 { margin-bottom: 6px; }
    .qr-item p { margin-bottom: 10px; font-size: 14px; color: #555; }
  </style>
</head>
<body>

<header>
  <span>üìò Dashboard Guru</span>
  <button id="logoutBtn">Logout</button>
</header>

<div class="container">
  <div class="card">
    <h2>Tambah Siswa</h2>
    <div class="input-group"><i class="fas fa-school"></i><input type="text" id="namaSekolah" placeholder="Nama Sekolah"></div>
    <div class="input-group"><i class="fas fa-user"></i><input type="text" id="namaSiswa" placeholder="Nama Siswa"></div>
    <div class="input-group"><i class="fas fa-id-card"></i><input type="text" id="nisSiswa" placeholder="NIS / Username"></div>
    <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="passwordSiswa" placeholder="Password"></div>
    <button id="tambahBtn" onclick="tambahSiswa()" disabled>Tambah</button>
  </div>

  <div class="card">
    <h2>Daftar Siswa & QR Code</h2>
    <div class="qr-list" id="qrList"></div>
  </div>
</div>

<!-- Firebase & QR Code -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, query, where, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBd6nLyyJF7_1-4q6x3YQ2ANoy5sYb6De8",
    authDomain: "my-absensiqr.firebaseapp.com",
    projectId: "my-absensiqr",
    storageBucket: "my-absensiqr.firebasestorage.app",
    messagingSenderId: "109726198069",
    appId: "1:109726198069:web:f03a7ad718f909d0f9847c"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentGuruUID = null;
  const tambahBtn = document.getElementById("tambahBtn");

  // Cek login
  onAuthStateChanged(auth, user => {
    if(user){
      currentGuruUID = user.uid;
      tambahBtn.disabled = false;
      renderQR();
    } else {
      window.location.href = "index.html";
    }
  });

  // Tambah siswa
  async function tambahSiswa(){
    if(!currentGuruUID){
      alert("‚ö†Ô∏è Menunggu verifikasi login, silakan tunggu sebentar.");
      return;
    }

    const sekolah = document.getElementById("namaSekolah").value.trim();
    const nama = document.getElementById("namaSiswa").value.trim();
    const nis = document.getElementById("nisSiswa").value.trim();
    const pass = document.getElementById("passwordSiswa").value.trim();

    if(!sekolah || !nama || !nis || !pass){
      alert("Lengkapi semua field!");
      return;
    }

    const uniqueID = nis + "_" + Date.now();

    try {
      await setDoc(doc(db, "siswa", uniqueID), {
        guruUID: currentGuruUID,
        sekolah,
        nama,
        nis,
        pass,
        uniqueID,
        createdAt: serverTimestamp()
      });

      alert("‚úÖ Siswa berhasil ditambahkan!");
      document.getElementById("namaSekolah").value = "";
      document.getElementById("namaSiswa").value = "";
      document.getElementById("nisSiswa").value = "";
      document.getElementById("passwordSiswa").value = "";

      renderQR();
    } catch (error) {
      console.error("Error:", error);
      alert("‚ùå Gagal menambah siswa");
    }
  }
  window.tambahSiswa = tambahSiswa;

  // Render siswa + QR
  async function renderQR(){
    if(!currentGuruUID) return;

    const qrList = document.getElementById("qrList");
    qrList.innerHTML = "";

    try {
      const q = query(
        collection(db, "siswa"),
        where("guruUID","==", currentGuruUID),
        orderBy("createdAt","desc")
      );
      const snapshot = await getDocs(q);

      snapshot.forEach(docSnap => {
        const s = docSnap.data();
        const div = document.createElement("div");
        div.className = "qr-item";
        div.innerHTML = `
          <h4>${s.nama} (${s.nis})</h4>
          <p>üè´ ${s.sekolah}</p>
          <div id="qr_${s.uniqueID}"></div>
        `;
        qrList.appendChild(div);

        new QRCode(document.getElementById("qr_" + s.uniqueID), {
          text: s.uniqueID,
          width: 128,
          height: 128
        });
      });
    } catch (error) {
      console.error("Error load siswa:", error);
    }
  }

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "index.html";
  });
</script>

</body>
</html>
